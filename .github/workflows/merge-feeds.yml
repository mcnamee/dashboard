name: Merge News Feeds

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'feeds/abc.json'
      - 'feeds/perplexity.json'

jobs:
  merge-feeds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v6
        
      - name: Setup Python ðŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies ðŸ
        run: pip install python-dateutil

      - name: Merge JSON feeds â›˜
        run: |
          python -c "
import json
from datetime import datetime
from dateutil import parser

# Load both feeds
try:
    with open('feeds/abc.json', 'r') as f:
        abc = json.load(f)
except FileNotFoundError:
    abc = {'items': []}
    
try:
    with open('feeds/perplexity.json', 'r') as f:
        perplexity = json.load(f)
except FileNotFoundError:
    perplexity = {'items': []}

# Extract items from both feeds
abc_items = abc.get('items', [])
perplexity_items = perplexity.get('items', [])

# Combine all items
all_items = abc_items + perplexity_items

# Robust date parsing function
def parse_date(dt_str):
    if not dt_str:
        return datetime.min
    try:
        # Try standard ISO format first
        return parser.parse(dt_str)
    except:
        try:
            # Fallback: manual parsing for common formats
            return datetime.fromisoformat(dt_str.replace('Z', '+00:00'))
        except:
            print(f'Warning: Could not parse date: {dt_str}')
            return datetime.min

# Sort by publisheddatetime (newest first)
all_items.sort(key=lambda x: parse_date(x.get('publisheddatetime', '')), reverse=True)

# Create merged feed
merged = {
    'items': all_items,
    'total_items': len(all_items),
    'abc_items': len(abc_items),
    'perplexity_items': len(perplexity_items),
    'merged_at': datetime.utcnow().isoformat()
}

# Write to feeds/main.json
with open('feeds/main.json', 'w') as f:
    json.dump(merged, f, indent=2, default=str)

print(f'Merged {len(abc_items)} ABC + {len(perplexity_items)} Perplexity = {len(all_items)} total items')
if all_items:
    print(f'Newest: {all_items[0].get(\"title\", \"No title\")[:60]}...')
    print(f'Oldest: {all_items[-1].get(\"title\", \"No title\")[:60]}...')
          "

      - name: Generate commit message ðŸ“†
        id: date
        run: echo "commit_message=News Merged - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

      - name: Commit changes ðŸš€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.commit_message }}
          file_pattern: feeds/main.json
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          push_options: --force

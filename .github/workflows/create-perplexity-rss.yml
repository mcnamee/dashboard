name: Create Perplexity RSS Feed

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Fetch Perplexity Discover Feed"]
    types: [completed]
    branches: [main]

jobs:
  create-rss:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v6
        
      - name: Setup Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies ğŸ
        run: pip install feedgen python-dateutil

      - name: Create RSS feed â›˜
        run: |
          python << 'PYCODE'
          import json
          from feedgen.feed import FeedGenerator
          from datetime import timezone
          from dateutil import parser
          import re

          def clean_string(text):
              cleaned = re.sub(r'\[.*?\]', '', text) # Remove all text within [ and ], inclusive
              cleaned = cleaned.replace('\n', ' ') # Replace \n with <br /><br />
              return cleaned

          def parse_aware(dt_str):
              if not dt_str:
                  return None
              dt = parser.parse(dt_str)
              if dt.tzinfo is None:
                  dt = dt.replace(tzinfo=timezone.utc)
              return dt

          # Load JSON from file or API
          try:
              with open('feeds/perplexity.json', 'r') as f:
                  json_feed = json.load(f)
          except FileNotFoundError:
              json_feed = {'items': []}

          items = json_feed.get('items', [])

          fg = FeedGenerator()
          fg.load_extension('media')
          fg.title('Perplexity Discover')
          fg.link(href='https://perplexity.ai/discover', rel='alternate')
          fg.description('Perplexity\'s Discover News Feed.')
          fg.image(
              url='https://docs.perplexity.ai/favicon.png',
              title='Perplexity Discover',
              link='https://perplexity.ai/discover'
          )

          for obj in items:
              image_url = (obj.get("featured_image") or {}).get("thumbnail", "")
              desc = clean_string(obj.get("description", ""))
              slug = obj.get('url', '')
              link_url = f"https://perplexity.ai/discover/you/{slug}"
              pub_dt = parse_aware(obj.get('published_datetime'))

              fe = fg.add_entry()
              fe.title(obj.get('title', 'No title'))
              fe.link(href=link_url)
              fe.description(desc)

              if image_url:
                  fe.media.content(
                      url=image_url,
                      medium="image",
                      type="image/jpeg"
                  )

              if pub_dt:
                  fe.pubDate(pub_dt)

          rss_str = fg.rss_str(pretty=True)
          with open("feeds/perplexity-rss.xml", "wb") as f:
              f.write(rss_str)
          PYCODE

      - name: Generate commit message ğŸ“†
        id: date
        run: echo "commit_message=Perplexity RSS Feed Created - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

      - name: Commit changes ğŸš€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.commit_message }}
          file_pattern: feeds/perplexity-rss.xml
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          push_options: --force

name: Fetch ABC Top Stories Feed

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v6

      - name: Fetch ABC Feed ðŸ“°
        id: fetch
        run: |
          sudo apt update
          sudo apt install xmlstarlet

          RSS_URL="https://www.abc.net.au/news/feed/10719986/rss.xml"
          OUTPUT_FILE="feeds/abc.json"

          mkdir -p "$(dirname "$OUTPUT_FILE")"

          curl -s "$RSS_URL" > /tmp/feed.xml

          xmlstarlet sel -t \
            -m "//item[title and link]" \
            -v "normalize-space(pubDate)" -o "|" \
            -v "normalize-space(title)" -o "|" \
            -v "normalize-space(link)" -o "|" \
            -v "normalize-space(description)" -o "|" \
            -v "enclosure/@url" -o "|" \
            -v "media:group/media:content/@url" -o "|" \
            -v "media:content/@url" -n \
            /tmp/feed.xml | \
          while IFS='|' read -r pubDate title link desc image1 image2 image3 || [ -n "$pubDate" ]; do
            # Skip completely empty lines or invalid items
            [[ -z "$title" || -z "$link" ]] && continue

            # Pick first available image
            image="${image1:-${image2:-${image3:-}}}"
            
            # Robust date parsing
            iso_date=$(date -d "${pubDate:0:30}" +"%Y-%m-%dT%H:%M:%S.000000Z" 2>/dev/null || echo "1970-01-01T00:00:00.000000Z")
            
            jq -n \
              --arg dt "$iso_date" \
              --arg t "$title" \
              --arg img "$image" \
              --arg d "${desc:-}" \
              --arg u "$link" \
              '{published_datetime: $dt, title: $t, featured_image: $img, description: $d, url: $u}'

          done | jq -s '{items: .}' > "$OUTPUT_FILE"

          rm -f /tmp/feed.xml

          # Clean up empty items post-process
          jq '.items |= map(select(.title != "" and .url != ""))' "$OUTPUT_FILE" > /tmp/clean.json && mv /tmp/clean.json "$OUTPUT_FILE"

          # Verify response is valid JSON
          if ! jq empty $OUTPUT_FILE 2>/dev/null; then
            echo "Error: Invalid JSON response"
            exit 1
          fi
          
          echo "feed_size=$(wc -c < $OUTPUT_FILE)" >> $GITHUB_OUTPUT

      - name: Generate commit message ðŸ“†
        id: date
        run: echo "commit_message=Fetch News from ABC - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

      - name: Commit changes ðŸš€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.commit_message }}
          file_pattern: feeds/abc.json
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          push_options: --force


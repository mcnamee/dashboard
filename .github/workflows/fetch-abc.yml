name: Fetch ABC Top Stories Feed

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v6

      - name: Fetch ABC Feed ðŸ“°
        id: fetch
        run: |
          RSS_URL="https://www.abc.net.au/news/feed/10719986/rss.xml"
          OUTPUT_FILE="feeds/abc.json"

          mkdir -p "$(dirname "$OUTPUT_FILE")"

          curl -s "$RSS_URL" | jq '
            .rss.channel.item as $items |
            {
              items: $items | map({
                published_datetime: (.pubDate | strptime("%a, %d %b %Y %H:%M:%S %z") | strftime("%Y-%m-%dT%H:%M:%S.000000")),
                title: .title,
                featured_image: (.enclosure["@attributes"].url // (.["media:content"]["@attributes"].url // empty)),
                description: (.description // ""),
                url: .link
              })
            }
          ' > "$OUTPUT_FILE"
          
          # Verify response is valid JSON
          if ! jq empty $OUTPUT_FILE 2>/dev/null; then
            echo "Error: Invalid JSON response"
            exit 1
          fi
          
          echo "feed_size=$(wc -c < $OUTPUT_FILE)" >> $GITHUB_OUTPUT

      - name: Generate commit message ðŸ“†
        id: date
        run: echo "commit_message=Fetch News from ABC - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

      - name: Commit changes ðŸš€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.commit_message }}
          file_pattern: feeds/abc.json
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          push_options: --force


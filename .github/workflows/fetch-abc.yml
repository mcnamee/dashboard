xmlstarlet sel -t \
  -m "//item" \
  -v "pubDate" -o "|" \
  -v "title" -o "|" \
  -v "link" -o "|" \
  -v "description" -o "|" \
  -v "enclosure/@url" -o "|" \
  -v "media:content/@url" -n \
  /tmp/feed.xml | \
grep -v '^$' | grep -v '^\s*\|*\s*$' | \
while IFS='|' read -r pubDate title link desc image1 image2; do
  # Skip if no title (invalid item)
  [[ -n "$title" && -n "$link" ]] || continue
  
  image="${image1:-${image2:-}}"
  iso_date=$(date -d "$pubDate" +"%Y-%m-%dT%H:%M:%S.000000Z" 2>/dev/null || echo "1970-01-01T00:00:00.000000Z")
  
  jq -n \
    --arg dt "$iso_date" \
    --arg t "$title" \
    --arg img "$image" \
    --arg d "$desc" \
    --arg u "$link" \
    '{published_datetime: $dt, title: $t, featured_image: $img, description: $d, url: $u}'
done | jq -s '{items: .}' > "$OUTPUT_FILE"

name: Fetch ABC Top Stories Feed

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v6

      - name: Fetch ABC Feed ðŸ“°
        id: fetch
        run: |
          sudo apt update
          sudo apt install xmlstarlet

          RSS_URL="https://www.abc.net.au/news/feed/10719986/rss.xml"
          OUTPUT_FILE="/feeds/abc.json"

          mkdir -p "$(dirname "$OUTPUT_FILE")"

          curl -s "$RSS_URL" > /tmp/feed.xml

          xmlstarlet sel -t -m "//item" \
            -v "pubDate" -o " " \
            -v "title" -o " " \
            -v "link" -o " " \
            -v "description" -o " " \
            -v "enclosure/@url" -o " " \
            -v "media:content/@url" -n \
            /tmp/feed.xml | while read -r pubdate title link desc enclosure media; do
              image="${enclosure:-$media}"
              
              # Convert RFC 822 to ISO 8601
              iso_date=$(date -d "$pubdate" +"%Y-%m-%dT%H:%M:%S.%f" 2>/dev/null | sed 's/....$//')
              
              jq -n \
                --arg dt "$iso_date" \
                --arg title "$title" \
                --arg image "${image:-}" \
                --arg desc "$desc" \
                --arg url "$link" \
                '{published_datetime: $dt, title: $title, featured_image: $image, description: $desc, url: $url}'
          done | jq -s '{items: .}' > "$OUTPUT_FILE"
          
          # Verify response is valid JSON
          if ! jq empty $OUTPUT_FILE 2>/dev/null; then
            echo "Error: Invalid JSON response"
            exit 1
          fi
          
          echo "feed_size=$(wc -c < $OUTPUT_FILE)" >> $GITHUB_OUTPUT

      - name: Generate commit message ðŸ“†
        id: date
        run: echo "commit_message=Fetch News from ABC - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

      - name: Commit changes ðŸš€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.commit_message }}
          file_pattern: feeds/abc.json
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          push_options: --force


name: Fetch ABC Top Stories Feed

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v6

      - name: Fetch ABC Feed ðŸ“°
        id: fetch
        run: |
          sudo apt install xml2json

          RSS_URL="https://www.abc.net.au/news/feed/10719986/rss.xml"
          OUTPUT_FILE="/feeds/abc.json"

          mkdir -p "$(dirname "$OUTPUT_FILE")"

          curl -s "$RSS_URL" > /tmp/feed.xml
          xml2json /tmp/feed.xml > /tmp/feed.json

          jq '{
            "items": (
              .rss.channel.item[] |
              {
                "published_datetime": (.pubDate | strptime("%a, %d %b %Y %H:%M:%S %z") | strftime("%Y-%m-%dT%H:%M:%S.%f") | rtrimstr("Z")),
                "title": .title,
                "featured_image": (.enclosure["@attributes"].url // .["media:content"]["@attributes"].url // ""),
                "description": .description,
                "url": .link
              }
            )
          }' /tmp/feed.json > "$OUTPUT_FILE"
          
          # Verify response is valid JSON
          if ! jq empty $OUTPUT_FILE 2>/dev/null; then
            echo "Error: Invalid JSON response"
            exit 1
          fi
          
          echo "feed_size=$(wc -c < $OUTPUT_FILE)" >> $GITHUB_OUTPUT

      - name: Generate commit message ðŸ“†
        id: date
        run: echo "commit_message=Fetch News from ABC - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

      - name: Commit changes ðŸš€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.commit_message }}
          file_pattern: feeds/abc.json
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          push_options: --force


  name: Fetch ABC Top Stories Feed

  on:
    schedule:
      - cron: '0 * * * *'
    workflow_dispatch:

  jobs:
    fetch-and-commit:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout ðŸ›Žï¸
          uses: actions/checkout@v6

        - name: Fetch ABC Feed ðŸ“°
          id: fetch
          run: |
            sudo apt update
            sudo apt install xmlstarlet

            RSS_URL="https://www.abc.net.au/news/feed/10719986/rss.xml"
            OUTPUT_FILE="feeds/abc.json"

            mkdir -p "$(dirname "$OUTPUT_FILE")"

            curl -s "$RSS_URL" > /tmp/feed.xml

            xmlstarlet sel -t -m "//item" \
              -o '{"published_datetime":"' \
              -v "pubDate" \
              -o '","title":"' \
              -v "title" \
              -o '","featured_image":"' \
              -v "enclosure/@url[1]" \
              -o '" "' \
              -v "media:content/@url[1]" \
              -o '","description":"' \
              -v "description" \
              -o '","url":"' \
              -v "link" \
              -o '"}' -n \
              /tmp/feed.xml | \
            jq -sR '{items: (fromjson | map(fromjson))}' > "$OUTPUT_FILE"

            # Fix dates in-place using jq
            jq '
              .items |= map(
                if .published_datetime then
                  .published_datetime |= ( 
                    date -d "\(. | gsub("\\+"; " +") | gsub("-"; " -"))" +"%Y-%m-%dT%H:%M:%S.000000" 2>/dev/null // . 
                    | gsub("\\.[0-9]+"; "") 
                  )
                else . end
              )
            ' "$OUTPUT_FILE" > /tmp/fixed.json && mv /tmp/fixed.json "$OUTPUT_FILE"
            
            # Verify response is valid JSON
            if ! jq empty $OUTPUT_FILE 2>/dev/null; then
              echo "Error: Invalid JSON response"
              exit 1
            fi
            
            echo "feed_size=$(wc -c < $OUTPUT_FILE)" >> $GITHUB_OUTPUT

        - name: Generate commit message ðŸ“†
          id: date
          run: echo "commit_message=Fetch News from ABC - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

        - name: Commit changes ðŸš€
          uses: stefanzweifel/git-auto-commit-action@v5
          with:
            commit_message: ${{ env.commit_message }}
            file_pattern: feeds/abc.json
            commit_user_name: github-actions[bot]
            commit_user_email: github-actions[bot]@users.noreply.github.com
            push_options: --force


name: Fetch Perplexity Search Results

on:
  schedule:
    - cron: '0 15 * * *'
  workflow_dispatch:

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v6

      - name: Setup Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies ğŸ
        run: pip install requests

      - name: Fetch Discover Feed ğŸ“°
        id: fetch
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          python << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime
          import sys
              
          url = "https://api.perplexity.ai/chat/completions"

          headers = {
              "Authorization": f"Bearer {os.getenv('PERPLEXITY_API_KEY')}",
              "Content-Type": "application/json"
          }

          payload = {
              "model": "sonar-pro",
              "messages": [
                  {
                      "role": "system",
                      "content": """You are a news aggregator, that provides a JSON response in the exact format: 
          {
            "items": [
              {
                "published_datetime": "2025-12-21T01:50:00.000000Z",
                "title": "Palo Alto Networks Integrates Vertex AI for Real-Time Threat Analysis",
                "featured_image": {
                  "thumbnail": "https://www.securityweek.com/wp-content/uploads/2025/12/palo-alto-google.jpg"
                },
                "description": "The cybersecurity giant is migrating its key workloads to Googleâ€™s Vertex AI platform to leverage Gemini models for faster automated threat detection and governance [web:5].",
                "page_content_url": "https://www.securityweek.com/palo-alto-networks-adopts-google-vertex-ai/"
              }
            ]
          }
          You do not hallucinate and make up data. All fields are required, except for featured_image and description. If you don't have data to fill an optional field, leave it blank.
          """
                  },
                  {
                      "role": "user",
                      "content": "Give me the top 24 news stories that have been published in the past 24 hours. The articles should be in the topics of technology, world news, national security, Australian Signals Directorate, cyber security, technology, artificial intelligence, big tech, geopolitics, military, world affairs, finance, Australian federal Government. Only give me articles that were published in the past 24hrs. Please only source from reputable sources."
                  }
              ],
              "stream": False
          }

          try:
              response = requests.post(url, headers=headers, json=payload, timeout=30)
              response.raise_for_status()
              
              data = response.json()
              
              # Extract the content from choices[0].message.content
              content = data["choices"][0]["message"]["content"]
              
              # Parse the plain text JSON content
              news_json = json.loads(content)

              output_dir = "feeds"
              
              # Ensure output directory exists
              os.makedirs(output_dir, exist_ok=True)

              # Save to feeds/search.json
              output_path = os.path.join(output_dir, "perplexity-search.json")
              with open(output_path, "w", encoding="utf-8") as f:
                  json.dump(news_json, f, indent=2, ensure_ascii=False)
              
              print(f"âœ… Saved {len(news_json['items'])} stories to {output_path}")
              print(f"ğŸ“… Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S AEDT')}")
              
          except requests.exceptions.RequestException as e:
              print(f"âŒ API request failed: {e}", file=sys.stderr)
              sys.exit(1)
          except (json.JSONDecodeError, KeyError) as e:
              print(f"âŒ JSON parsing failed: {e}", file=sys.stderr)
              print(f"Response content: {content[:500]}..." if 'content' in locals() else "No content received", file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f"âŒ Unexpected error: {e}", file=sys.stderr)
          EOF

      - name: Generate commit message ğŸ“†
        id: date
        run: echo "commit_message=Fetch Search from Perplexity - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

      - name: Commit changes ğŸš€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.commit_message }}
          file_pattern: feeds/perplexity-search.json
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          push_options: --force


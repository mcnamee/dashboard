name: Fetch Perplexity Search Results

on:
  schedule:
    - cron: '0 15 * * *'
  workflow_dispatch:

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v6

      - name: Setup Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies ğŸ
        run: pip install requests

      - name: Fetch Discover Feed ğŸ“°
        id: fetch
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          python << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime
          import sys
              
          url = "https://api.perplexity.ai/chat/completions"

          headers = {
              "Authorization": f"Bearer {os.getenv('PERPLEXITY_API_KEY')}",
              "Content-Type": "application/json"
          }

          payload = {
              "model": "gemini-3.0-flash",
              "messages": [
                  {
                      "role": "system",
                      "content": """You are a news aggregator. Provide a JSON summary containing the top 24 news stories that have been published in the past 24 hours. The articles should be in the topics of technology, world news, national security, Australian Signals Directorate, cyber security, technology, artificial intelligence, big tech, geopolitics, military, world affairs, finance, Australian federal Government. Only give me articles that were published in the past 24hrs. Only give me articles that would be of interest to an Australian Government signals intelligence senior executive, to enable them to keep informed of world events. Please only source from reputable sources. If you can't find 24 articles to meet that criteria, that's ok. The JSON format should be exactly: 
          {
          "items": [
          {
              "published_datetime": "2025-12-18T19:43:23.000000Z",
              "title": "CISA and NSA Alert: BRICKSTORM Backdoor Targets Critical Infrastructure",
              "featured_image": {
              "thumbnail": "https://cybersecuritynews.com/wp-content/uploads/2025/12/brickstorm-malware.jpg"
              },
              "description": "A joint advisory from U.S. and Canadian intelligence warns of the BRICKSTORM backdoor, a sophisticated tool used by state-backed actors for persistent access to VMware and Windows environments.",
              "page_content_url": "https://cybersecuritynews.com/cisa-releases-indicators-of-compromise-tied-to-brickstorm-malware/"
          }
          ]
          }"""
                  },
                  {
                      "role": "user",
                      "content": "top 8 trending technology stories today"
                  }
              ],
              "stream": False
          }

          try:
              response = requests.post(url, headers=headers, json=payload, timeout=30)
              response.raise_for_status()
              
              data = response.json()
              
              # Extract the content from choices[0].message.content
              content = data["choices"][0]["message"]["content"]
              
              # Parse the plain text JSON content
              news_json = json.loads(content)

              output_dir = "feeds"
              
              # Ensure output directory exists
              os.makedirs(output_dir, exist_ok=True)

              # Save to feeds/search.json
              output_path = os.path.join(output_dir, "perplexity-search.json")
              with open(output_path, "w", encoding="utf-8") as f:
                  json.dump(news_json, f, indent=2, ensure_ascii=False)
              
              print(f"âœ… Saved {len(news_json['items'])} stories to {output_path}")
              print(f"ğŸ“… Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S AEDT')}")
              
          except requests.exceptions.RequestException as e:
              print(f"âŒ API request failed: {e}", file=sys.stderr)
              sys.exit(1)
          except (json.JSONDecodeError, KeyError) as e:
              print(f"âŒ JSON parsing failed: {e}", file=sys.stderr)
              print(f"Response content: {content[:500]}..." if 'content' in locals() else "No content received", file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f"âŒ Unexpected error: {e}", file=sys.stderr)
          EOF

      - name: Generate commit message ğŸ“†
        id: date
        run: echo "commit_message=Fetch Search from Perplexity - $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV

      - name: Commit changes ğŸš€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ env.commit_message }}
          file_pattern: feeds/perplexity-search.json
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          push_options: --force

